<!DOCTYPE html>
<html>
<head>
    <title>KityFormula公式编辑器</title>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">

    <link rel="stylesheet" href="assets/styles/page.css">
    <link rel="stylesheet" href="assets/styles/base.css">
    <link rel="stylesheet" href="assets/styles/scrollbar.css">
    <link rel="stylesheet" href="assets/theme/default/fui.min.css">
    <link rel="stylesheet" href="assets/theme/default/fui.ext.css">
    <style>

        .bottom-bar {
            text-align: right;
            background: white;
            border-bottom: 1px solid #b6b6b6;
            height: 49px;
        }

        .kf-ok-btn, .kf-cancel-btn {
            height: 30px;
            font-size: 18px;
            line-height: 30px;
            padding: 0 20px;
            margin-top: 10px;
            margin-right: 10px;
            border: 1px solid #357ebd;
            background-color: #428bca;
            box-shadow: 0 0 1px rgba(0,0,0,.3) inset;
            border-radius: 2px 0 0 2px;
            font-weight: bold;
        }

        .kf-cancel-btn {
            background-color: #c9302c;
            border-color: #ac2925;
        }

        .kf-ok-btn .fui-label, .kf-cancel-btn .fui-label {
            color: #fff;
        }

        .kf-ok-btn:HOVER {
            border-color: #285e8e;
            background-color: #3071a9;
        }

        .kf-cancel-btn:HOVER {
            background-color: #ae211a;
            border-color: #9c1b16;
        }

    </style>

    <script src="../config/ui.conf.js"></script>
    <script src="/math/static/js/jquery-1.11.1.min.js"></script>
    <script src="../lib/jhtmls.min.js"></script>
    <script src="../lib/fui.all.js"></script>
    <script src="../lib/kitygraph.all.min.js"></script>
    <script src="../lib/kity-formula-render.all.js"></script>
    <script src="../lib/kity-formula-parser.all.js"></script>
    <script src="../lib/kityformula-editor.all.js"></script>
    <script>
        var ckEditor = null,
            kfEditor = null,
            cache = null,
            hashParams = parseHash();

        ckEditor = top.__ckEditor_poll[ hashParams.id ];

        cache = ckEditor.__kf_cache;
        ckEditor.clear();

        jQuery( function ($) {

            var factory = kf.EditorFactory.create( $( "#eidotr" )[ 0 ], {
                    render: {
                        fontsize: 40
                    },
                    resource: {
                        path: "../resource/"
                    }
                }),
                uniqueId = location.hash.substring( 1 );

            factory.ready( function () {

                var source = hashParams.source || '\\placeholder';

                this.execCommand( "render", source );
                this.execCommand( "focus" );

                kfEditor = this;

                kfEditor.execCommand( 'resize.notify', function ( height ) {
                    ckEditor.__kf_notify_size( height );
                } );

                ckEditor.__kf_editor = kfEditor;

            } );

            window.onhashchange = function () {
                cache = ckEditor.__kf_cache;
                ckEditor.clear();
                hashParams = parseHash();
                kfEditor.execCommand( 'render', hashParams.source || '\\placeholder' );
                kfEditor.execCommand( 'focus' );
            };

            var panel = new FUI.Panel( {
                    className: 'kf-bottom-panel'
                } ),
                okBtn = new FUI.Button( {
                    className: 'kf-ok-btn',
                    label: '确定'
                } ),
                cancelBtn = new FUI.Button( {
                    className: 'kf-cancel-btn',
                    label: '取消'
                } );

            okBtn.appendTo( panel );
            cancelBtn.appendTo( panel );

            panel.appendTo( $( '.bottom-bar' )[0] );

            okBtn.on( "click", function () {
                var source = kfEditor.execCommand( "get.source" );
                insertFormula( source );
                ckEditor.clear();
                kfEditor.execCommand( "reset" );
                ckEditor.__kf_close();
                cache = null;
            } );

            cancelBtn.on( "click", function () {
                kfEditor.execCommand( "reset" );
                ckEditor.clear();
                ckEditor.__kf_close();
                cache = null;
            } );

        } );

        function parseHash () {

            var tmp = null,
                hashParams = {},
                hash = location.hash.substring( 1 );

            hash = hash.split( '&' );

            for ( var i = 0, len = hash.length; i < len; i++ ) {
                tmp = hash[ i ].split( '=', 2 );
                hashParams[ tmp[ 0 ] ] = tmp[ 1 ];
            }

            return hashParams;

        }

        function insertFormula ( source ) {

            var ele = null,
                range = ckEditor.getSelection().getRanges()[0];

            if ( range && range.endContainer.type === 1 && range.endContainer.getName() === 'iframe' ) {
                range.moveToPosition( range.endContainer, top.CKEDITOR.POSITION_AFTER_END );
                ckEditor.getSelection().selectRanges( [ range ] );
            }

            if ( cache ) {

                ele = cache.target;

                range.moveToPosition( new top.CKEDITOR.dom.element( ele ), top.CKEDITOR.POSITION_AFTER_END );
                ckEditor.getSelection().selectRanges( [ range ] );

                ele.setAttribute( "data-source", source );
                ele.setAttribute( "src", getMathjaxPath( source ) );

            } else {

                ele = ckEditor.document.createElement( 'iframe', {
                    attributes: {
                        contenteditable: false,
                        frameborder: 0,
                        "data-source": source,
                        src: getMathjaxPath( source )
                    },
                    styles: {
                        "vertical-align": "middle",
                        width: "100px",
                        height: "18px"
                    }
                } );

                ele.addClass( "kf-formula-expression" );

                ckEditor.insertElement( ele );
            }

        }

        // return Mathjax page URL
        function getMathjaxPath ( source ) {

            var url = document.URL;

            url = url.split( "#" )[0];
            url = url.split( "?" )[0];
            url = url.split( "/" );

            url.length -= 1;

            return encodeURI( url.join( "/" ) + "/mathjax.html?" + source );

        }

    </script>
</head>
<body>
    <div id="eidotr" class="kf-editor" style="width: 100%; height: 500px;"></div>
    <div class="bottom-bar"></div>
</body>
</html>
